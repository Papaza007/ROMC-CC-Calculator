<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROMC CC Calculator by Papaza007</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --border: #334155;
            
            /* Status Colors */
            --c-atk: #ef4444;
            --c-def: #3b82f6;
            --c-res: #10b981;
            --c-gold: #f59e0b;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
            overflow: hidden; /* ป้องกันการเลื่อนตอน Login บัง */
        }

        /* --- LOGIN OVERLAY STYLES (ส่วนที่เพิ่มมา) --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        .login-box {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--accent);
            text-align: center;
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.3);
            max-width: 400px;
            width: 90%;
        }
        .discord-btn {
            background-color: #5865F2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            margin-top: 20px;
            text-decoration: none;
            display: inline-block;
        }
        .discord-btn:hover { background-color: #4752C4; transform: scale(1.05); }
        .loading-text { margin-top: 15px; color: var(--text-muted); display: none; }
        .error-msg { color: var(--c-atk); margin-top: 15px; display: none; }

        /* --- Original Styles --- */
        .dashboard {
            background: var(--bg-card);
            width: 100%;
            max-width: 900px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            padding: 30px;
            /* เบลอพื้นหลังถ้ายังไม่ Login */
            filter: blur(5px); 
            transition: filter 0.5s;
        }

        /* เมื่อ Login ผ่าน Class นี้จะถูกเติม */
        body.logged-in .dashboard { filter: none; }
        body.logged-in #login-overlay { display: none; }

        /* ... (คง CSS เดิมไว้ทั้งหมดด้านล่างนี้) ... */
        .header-section { text-align: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        h1 { margin: 0 0 10px 0; font-weight: 600; text-transform: none; letter-spacing: 1px; }
        .select-wrapper { position: relative; max-width: 300px; margin: 0 auto; }
        select { width: 100%; padding: 12px 20px; background: var(--bg-input); color: #fff; border: 2px solid var(--accent); border-radius: 10px; font-family: 'Kanit', sans-serif; font-size: 1.1rem; cursor: pointer; outline: none; appearance: none; }
        .select-wrapper::after { content: '▼'; font-size: 0.8rem; color: var(--accent); position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }
        .card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
        .card-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid; display: flex; justify-content: space-between; }
        .t-atk { color: var(--c-atk); border-color: var(--c-atk); }
        .t-def { color: var(--c-def); border-color: var(--c-def); }
        .t-base { color: var(--text-muted); border-color: var(--text-muted); }
        .input-group { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .input-group label { font-size: 0.9rem; color: var(--text-muted); flex: 1; }
        .stat-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #334155; color: #fff; margin-right: 10px; min-width: 40px; text-align: center; }
        input[type="number"] { width: 80px; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 8px; border-radius: 6px; text-align: center; font-family: 'Kanit', sans-serif; font-size: 1rem; transition: all 0.2s; }
        input[type="number"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .result-section { margin-top: 30px; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; border: 1px solid var(--border); }
        .res-box h3 { margin: 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; }
        .res-value { font-size: 2.5rem; font-weight: 600; margin: 5px 0 0 0; line-height: 1; }
        .v-chance { color: var(--c-gold); text-shadow: 0 0 15px rgba(245, 158, 11, 0.2); }
        .v-duration { color: var(--c-def); }
        .v-time { color: var(--c-res); text-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .unit { font-size: 1rem; color: var(--text-muted); font-weight: 400; }
        .footer { margin-top: 20px; text-align: center; font-size: 0.8rem; color: #475569; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="login-overlay">
    <div class="login-box">
        <h2 style="margin-top:0;">Guild Member Access Only</h2>
        <p style="color: var(--text-muted);">ระบบสงวนสิทธิ์เฉพาะสมาชิก Discord Server เท่านั้น</p>
        
        <button id="btn-login" class="discord-btn" onclick="loginWithDiscord()">
            Login with Discord
        </button>
        
        <div id="loading" class="loading-text">กำลังตรวจสอบสิทธิ์...</div>
        <div id="error-msg" class="error-msg"></div>
    </div>
</div>

<div class="dashboard">
    <div class="header-section">
        <h1>CC Calculator by Papaza007</h1>
        <div class="select-wrapper">
            <select id="statusSelect"></select>
        </div>
    </div>

    <div class="grid-layout">
        <div class="col-left">
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title t-base">Base CC Stat</div>
                <div class="input-group">
                    <label>โอกาสติดพื้นฐาน จากสกิลหรืออุปกรณ์<br>(Base Chance from Skill or Item)</label>
                    <input type="number" id="inp_base" value="50" placeholder="%">
                </div>
                <div class="input-group">
                    <label>ระยะเวลาติดพื้นฐาน<br>(Base Duration Time)</label>
                    <input type="number" id="inp_time" value="10" placeholder="Sec">
                </div>
            </div>

            <div class="card">
                <div class="card-title t-atk">
                    Attacker (ฝ่ายโจมตี)
                    <span id="lbl_atk_stat" class="stat-badge" style="background:var(--c-atk)">STR</span>
                </div>
                <div class="input-group">
                    <label>ค่า Stat ผู้โจมตี (Stat Value)</label>
                    <input type="number" id="inp_atk_stat" value="0">
                </div>
                <div class="input-group">
                    <label>Stat เสริม(เช่น การ์ดผีผ้าดาว จะบวกอีก 25%)
                        <br>(e.g. from Wraith* card)</label>
                    <input type="number" id="inp_status_atk" value="0">
                </div>
                <div class="input-group">
                    <label>ส่วนเสริม %พิเศษ (เช่น หมวก Evil Crown)
                        <br>Special/CC Atk% (e.g. Evil Crown Headgear)</label>
                    <input type="number" id="inp_cc_atk" value="0">
                </div>
            </div>
        </div>

        <div class="col-right">
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-title t-def">Defender Stat (Stat ฝ่ายป้องกัน)</div>
                <div class="input-group">
                    <label>Total of -><span id="lbl_def_chance" class="stat-badge">VIT+LUK</span></label>
                    <input type="number" id="inp_def_chance" value="0">
                </div>
                <div class="input-group">
                    <label>Total of -><span id="lbl_def_time" class="stat-badge">VIT</span></label>
                    <input type="number" id="inp_def_time" value="0">
                </div>
            </div>

            <div class="card">
                <div class="card-title t-def" style="border-color: var(--c-res); color: var(--c-res);">
                    Defender Resistance (ค่า Resist ฝ่ายป้องกัน)
                </div>
                <div class="input-group">
                    <label>Status Resist % (กันสถานะ)</label>
                    <input type="number" id="inp_res" value="0">
                </div>
                <div class="input-group">
                    <label>CC Resist% (เช่น จากการ์ดหมายาย)<br>e.g. Grandma wolf C.</label>
                    <input type="number" id="inp_cc_res" value="0">
                </div>
            </div>
        </div>
    </div>

    <div class="result-section">
        <div class="res-box">
            <h3>Chance</h3>
            <div class="res-value v-chance" id="res_chance">0<span class="unit">%</span></div>
        </div>
        <div class="res-box">
            <h3>Duration</h3>
            <div class="res-value v-duration" id="res_duration_pct">100<span class="unit">%</span></div>
        </div>
        <div class="res-box">
            <h3>Final Time</h3>
            <div class="res-value v-time" id="res_final_time">0.00<span class="unit">s</span></div>
        </div>
    </div>
    
    <div class="footer">Powered by Papaza007</div>
</div>

<script>
    // ==========================================
    // 1. ส่วนตั้งค่า DISCORD LOGIN (แก้ไขตรงนี้)
    // ==========================================
    const DISCORD_CLIENT_ID = "1473502517437534460"; // เอาไอดีจาก Discord Developer Portal มาใส่
    const DISCORD_REDIRECT_URI = "https://papaza007.github.io/ROMC-CC-Calculator/"; // ใส่ URL ของหน้าเว็บนี้ (ต้องตรงกับใน Portal)
    const REQUIRED_GUILD_ID = "1208098247730528256"; // ใส่ ID ของ Server Discord ที่อนุญาตให้เข้า
    // ==========================================

    // ฟังก์ชัน Login
    function loginWithDiscord() {
        // สร้าง URL สำหรับ Login
        const scope = encodeURIComponent("identify guilds");
        const url = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(DISCORD_REDIRECT_URI)}&response_type=token&scope=${scope}`;
        window.location.href = url;
    }

    // ฟังก์ชันตรวจสอบสิทธิ์เมื่อโหลดหน้า
    window.onload = () => {
        // เช็คว่ามี Token กลับมาใน URL ไหม (หลัง Login เสร็จ)
        const fragment = new URLSearchParams(window.location.hash.slice(1));
        const accessToken = fragment.get('access_token');
        const tokenType = fragment.get('token_type');

        if (accessToken) {
            // มี Token -> กำลังตรวจสอบกับ Discord
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // ยิง API ไปถาม Discord ว่าอยู่ Guild ไหนบ้าง
            fetch('https://discord.com/api/users/@me/guilds', {
                headers: { authorization: `${tokenType} ${accessToken}` }
            })
            .then(res => res.json())
            .then(guilds => {
                // เช็คว่ามี Guild ID ที่เราต้องการไหม
                const isMember = guilds.some(g => g.id === REQUIRED_GUILD_ID);
                
                if (isMember) {
                    // ผ่าน! -> ปลดล็อคหน้าจอ
                    document.body.classList.add('logged-in');
                    // ลบ Hash ใน URL ให้สวยงาม
                    history.replaceState(null, null, ' ');
                } else {
                    // ไม่ผ่าน -> แจ้งเตือน
                    showError("ขออภัย คุณไม่ได้เป็นสมาชิกใน Discord Server ที่กำหนด");
                }
            })
            .catch(err => {
                showError("เกิดข้อผิดพลาดในการเชื่อมต่อ Discord");
                console.error(err);
            });
        }
    };

    function showError(msg) {
        document.getElementById('loading').style.display = 'none';
        const errDiv = document.getElementById('error-msg');
        errDiv.innerText = msg;
        errDiv.style.display = 'block';
        document.getElementById('btn-login').style.display = 'inline-block'; // ให้ลองใหม่
    }

    // ==========================================
    // 2. ส่วนคำนวณเดิม (Original Logic)
    // ==========================================
    (function(){
        const API_URL = "https://script.google.com/macros/s/AKfycbyiwd2Ks5NkKd0IAJLVSs7EE9xo7dNf22DgbfCdQP__Pa4kbEo_pffvFlMjwjAmoikiEg/exec"; 

        const select = document.getElementById('statusSelect');
        const inputs = {
            base: document.getElementById('inp_base'),
            time: document.getElementById('inp_time'),
            atkStat: document.getElementById('inp_atk_stat'),
            statusAtk: document.getElementById('inp_status_atk'),
            ccAtk: document.getElementById('inp_cc_atk'),
            defChance: document.getElementById('inp_def_chance'),
            defTime: document.getElementById('inp_def_time'),
            res: document.getElementById('inp_res'),
            ccRes: document.getElementById('inp_cc_res')
        };
        const results = {
            chance: document.getElementById('res_chance'),
            durPct: document.getElementById('res_duration_pct'),
            finalTime: document.getElementById('res_final_time')
        };
        
        const configStats = [
            { name: 'Stun',    atk: 'STR', defC: 'VIT+AGI', defT: 'VIT' },
            { name: 'Blind',   atk: 'STR', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Curse',   atk: 'STR', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Fear',    atk: 'DEX', defC: 'INT+LUK', defT: 'INT' },
            { name: 'Sleep',   atk: 'DEX', defC: 'INT+LUK', defT: 'INT' },
            { name: 'Silence', atk: 'DEX', defC: 'VIT+STR', defT: 'VIT' },
            { name: 'Freeze',  atk: 'INT', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Bleed',   atk: 'INT', defC: 'VIT+INT', defT: 'VIT' },
            { name: 'Burn',    atk: 'INT', defC: 'VIT+AGI', defT: 'VIT' },
            { name: 'Stone',   atk: 'INT', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Poison',  atk: 'LUK', defC: 'VIT+INT', defT: 'VIT' },
            { name: 'Snare',   atk: 'AGI', defC: 'VIT+STR', defT: 'VIT' }
        ];

        configStats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.innerText = c.name;
            select.appendChild(opt);
        });

        function updateLabels() {
            const data = configStats.find(c => c.name === select.value);
            if(data) {
                document.getElementById('lbl_atk_stat').innerText = data.atk;
                document.getElementById('lbl_def_chance').innerText = data.defC;
                document.getElementById('lbl_def_time').innerText = data.defT;
            }
        }

        let timeout = null;
        function calculate() {
            results.finalTime.innerHTML = '...';
            if(timeout) clearTimeout(timeout);
            timeout = setTimeout(callServer, 500);
        }

        function callServer() {
            const params = new URLSearchParams();
            params.append('status', select.value);
            for(let key in inputs) {
                params.append(key, inputs[key].value);
            }

            fetch(API_URL + "?" + params.toString())
                .then(res => res.json())
                .then(data => {
                    results.chance.innerHTML = parseFloat(data.chance).toFixed(2) + '<span class="unit">%</span>';
                    results.durPct.innerHTML = (parseFloat(data.durPct)*100).toFixed(0) + '<span class="unit">%</span>';
                    results.finalTime.innerHTML = parseFloat(data.finalTime).toFixed(2) + '<span class="unit">s</span>';
                })
                .catch(err => {
                    console.error("เกิดข้อผิดพลาด:", err);
                    results.finalTime.innerHTML = "Error";
                });
        }

        select.addEventListener('change', () => { updateLabels(); calculate(); });
        Object.values(inputs).forEach(input => {
            input.addEventListener('input', calculate);
        });

        updateLabels();
        calculate();

    })();
</script>

</body>
</html>




