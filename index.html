<script>
    (function(){
        // Security Code เดิมของคุณ
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        };

        // --- ใส่ลิงก์ที่คุณได้จาก Google Apps Script ตรงนี้ ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwY1raW-Tregm6C5OlVyzNlHiz8yF7A4m3vUMydbAbLuBttVpimS3MPqFYiO6vzvVX_gQ/exec"; 
        // ตัวอย่าง: const API_URL = "https://script.google.com/macros/s/AKfycbx.../exec";

        // Data Config สำหรับ Dropdown
        const config = [
            { name: 'Stun',    atk: 'STR', defC: 'VIT+AGI', defT: 'VIT' },
            { name: 'Blind',   atk: 'STR', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Curse',   atk: 'STR', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Fear',    atk: 'DEX', defC: 'INT+LUK', defT: 'INT' },
            { name: 'Sleep',   atk: 'DEX', defC: 'INT+LUK', defT: 'INT' },
            { name: 'Silence', atk: 'DEX', defC: 'VIT+STR', defT: 'VIT' },
            { name: 'Freeze',  atk: 'INT', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Bleed',   atk: 'INT', defC: 'VIT+INT', defT: 'VIT' },
            { name: 'Burn',    atk: 'INT', defC: 'VIT+AGI', defT: 'VIT' },
            { name: 'Stone',   atk: 'INT', defC: 'INT+DEX', defT: 'INT' },
            { name: 'Poison',  atk: 'LUK', defC: 'VIT+INT', defT: 'VIT' },
            { name: 'Snare',   atk: 'AGI', defC: 'VIT+STR', defT: 'VIT' }
        ];

        // UI References
        const select = document.getElementById('statusSelect');
        const labels = {
            atk: document.getElementById('lbl_atk_stat'),
            defC: document.getElementById('lbl_def_chance'),
            defT: document.getElementById('lbl_def_time')
        };
        const inputs = {
            base: document.getElementById('inp_base'),
            time: document.getElementById('inp_time'),
            atkStat: document.getElementById('inp_atk_stat'),
            statusAtk: document.getElementById('inp_status_atk'),
            ccAtk: document.getElementById('inp_cc_atk'),
            defChance: document.getElementById('inp_def_chance'),
            defTime: document.getElementById('inp_def_time'),
            res: document.getElementById('inp_res'),
            ccRes: document.getElementById('inp_cc_res')
        };
        const results = {
            chance: document.getElementById('res_chance'),
            durPct: document.getElementById('res_duration_pct'),
            finalTime: document.getElementById('res_final_time')
        };

        // Initialize Dropdown
        config.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.innerText = c.name;
            select.appendChild(opt);
        });

        function updateLabels() {
            const currentName = select.value;
            const data = config.find(c => c.name === currentName);
            labels.atk.innerText = data.atk;
            labels.defC.innerText = data.defC;
            labels.defT.innerText = data.defT;
        }

        // --- ฟังก์ชันใหม่: ส่งค่าไปคำนวณที่ Server ---
        let timeoutId;
        function calculate() {
            // แสดงสถานะกำลังโหลด
            results.finalTime.innerHTML = '...'; 
            results.finalTime.style.opacity = 0.5;

            // หน่วงเวลาเล็กน้อยเพื่อไม่ให้ส่งข้อมูลรัวเกินไป (Debounce)
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                fetchData();
            }, 500); 
        }

        function fetchData() {
            const params = new URLSearchParams({
                status: select.value,
                base: inputs.base.value,
                time: inputs.time.value,
                atkStat: inputs.atkStat.value,
                statusAtk: inputs.statusAtk.value,
                ccAtk: inputs.ccAtk.value,
                defChance: inputs.defChance.value,
                defTime: inputs.defTime.value,
                res: inputs.res.value,
                ccRes: inputs.ccRes.value
            });

            fetch(API_URL + "?" + params.toString())
            .then(response => response.json())
            .then(data => {
                // รับค่าผลลัพธ์มาแสดง
                results.chance.innerHTML = data.chance.toFixed(2) + '<span class="unit">%</span>';
                results.durPct.innerHTML = (data.durPct * 100).toFixed(0) + '<span class="unit">%</span>';
                results.finalTime.innerHTML = data.finalTime.toFixed(2) + '<span class="unit">s</span>';
                
                if(data.chance === 0) results.finalTime.style.opacity = 0.3;
                else results.finalTime.style.opacity = 1;
            })
            .catch(err => {
                console.error("Error:", err);
                results.finalTime.innerHTML = "Error";
            });
        }

        // Event Listeners
        select.addEventListener('change', () => {
            updateLabels();
            calculate();
        });

        Object.values(inputs).forEach(inp => {
            inp.addEventListener('input', calculate);
        });

        // Init
        updateLabels();
        calculate();

    })();
</script>
